<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<title>Minimal Ogv.js example</title>

	<script src="lib/ogv.js?version=OGV_VERSION"></script>
</head>
<body>

<div id="videoarea"></div>

<select onchange="switchmedia(this)">
	<option value="media/llama-drama-av1.webm">Llama drama (AV1, Opus; 180p)</option>
	<option value="media/curiosity.ogv">Curiosity's Seven Minutes of Terror (Vorbis, Theora; 160p)</option>
	<option value="media/ehren-paper_lights-96.opus">Ehren - Paper Lights (Opus)</option>
	<option value="media/pixel_aspect_ratio.ogg">Theora Test suite pixel_aspect_ratio.ogg</option>
</select>
<div>
<button onclick="play(sampleFile);">Play</button><button onclick="pause();">Pause/Unpause</button>
</div>


<script language="JavaScript">

var player = null;
var paused = false;
var sampleFile = 'media/llama-drama-av1.webm';

player = new OGVPlayer({
	// Bad flicker with WebGL on Firefox
	// fixed Safari stuttery capture by tweaking WebGL options
	// ok in Chrome
	//webGL: false
});
document.getElementById("videoarea").appendChild(player);

var vid = document.createElement('video');
vid.controls = true;
vid.playsInline = true;
vid.addEventListener('play', function(event) {
	player.play();
});
vid.addEventListener('pause', function(event) {
	player.pause();
});
document.getElementById("videoarea").appendChild(vid);

var captureStream;
var captureTrack;

player.addEventListener('loadedmetadata', function(_event) {
	console.log('loaded');
	var canvas = player.querySelector('canvas');
	captureStream = canvas.captureStream(0);
	captureTrack = captureStream.getVideoTracks()[0];
	if (!captureStream.requestFrame && !captureTrack.requestFrame) {
		console.log('warning: pulling at 60fps because no requestFrame support');
		captureStream = canvas.captureStream(60);		
	}
	vid.srcObject = captureStream;
});

player.addEventListener('play', function(_event) {
	vid.play();
});
player.addEventListener('pause', function(_event) {
	vid.pause();
});

player.addEventListener('framecallback', function(_event) {
	if (captureStream && captureStream.requestFrame) {
		// Firefox has it here
		captureStream.requestFrame();
	} else if (captureTrack && captureTrack.requestFrame) {
		// Chrome and Safari have it here
		captureTrack.requestFrame();
	}
});

function play(src) {
	//player = new OgvSwfPlayer();
	//player = document.createElement('video');
	player.src = src;
	player.play();	
}

function pause() {
	if(player) {
		if(!paused) {
			player.pause();
			paused = true;
		} else {
			player.play();
			paused = false;
		}
	}
}

function switchmedia(src) {
	sampleFile = src.value;
	play(sampleFile);
}

</script>

</body></html>
